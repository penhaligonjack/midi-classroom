<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Student – MIDI Classroom</title>
<style>
    body { font-family: Arial; text-align: center; }

    #keyboard {
        user-select: none;
        position: relative;
        margin: 20px auto;
        height: 200px;
        width: fit-content;
    }

    .white-key, .black-key {
        display: inline-flex;
        justify-content: center;
        align-items: flex-end;
        font-size: 10px;
        cursor: pointer;
    }

    .white-key {
        width: 40px;
        height: 200px;
        border: 1px solid #333;
        background: white;
        position: relative;
        z-index: 1;
    }

    .black-key {
        width: 28px;
        height: 120px;
        background: black;
        color: white;
        position: absolute;
        top: 0;
        z-index: 2;
        border-radius: 0 0 3px 3px;
    }

    .active-white {
        background: #ffdd88 !important;
    }
    .active-black {
        background: #bb8800 !important;
    }

    #status { margin-top: 10px; }
</style>
</head>
<body>

<h2>Student – MIDI Classroom</h2>

<label>Classroom:</label>
<select id="room">
    <option value="77">Classroom 77</option>
    <option value="78">Classroom 78</option>
</select>

<br><br>

<label>Keyboard Number:</label>
<select id="keyboardNum">
    ${Array.from({length: 15}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join("")}
</select>

<br><br>

<button id="connectBtn">Join Classroom</button>

<p id="status">Not connected</p>

<!-- Volume -->
<label>Volume: <span id="volLabel">80</span>%</label><br>
<input type="range" id="volume" min="0" max="100" value="80" />

<!-- Note name display -->
<h3>Last Note: <span id="noteName">(none)</span></h3>

<!-- Keyboard -->
<div id="keyboard"></div>

<script>
// ------------------------
//  SETTINGS
// ------------------------
const START_MIDI = 36; // C2
const END_MIDI   = 96; // C7 (61 keys)

// WebSocket auto-select
const WS_URL = (location.hostname === "localhost")
    ? "ws://localhost:8080"
    : `wss://${location.host}`;

// ------------------------
//  AUDIO ENGINE
// ------------------------
let audioCtx = null;
let gainNode = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = volume.value / 100;
        gainNode.connect(audioCtx.destination);
    }
}

function playTone(midi, velocity = 100) {
    initAudio();
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    const freq = 440 * Math.pow(2, (midi - 69) / 12);

    osc.frequency.value = freq;
    g.gain.value = (velocity / 127) * 0.6;

    osc.connect(g);
    g.connect(gainNode);

    osc.start();
    osc.stop(audioCtx.currentTime + 0.4);
}

// Volume control
const volume = document.getElementById("volume");
const volLabel = document.getElementById("volLabel");
volume.oninput = () => {
    volLabel.textContent = volume.value;
    if (gainNode) gainNode.gain.value = volume.value / 100;
};

// ------------------------
//  BUILD KEYBOARD
// ------------------------
const keyboardDiv = document.getElementById("keyboard");

const BLACKS = [1, 3, 6, 8, 10];
function isBlack(m) { return BLACKS.includes(m % 12); }

const NOTE_NAMES = ["C","C#/Db","D","D#/Eb","E","F","F#/Gb","G","G#/Ab","A","A#/Bb","B"];

function midiToName(m) {
    return NOTE_NAMES[m % 12] + (Math.floor(m/12) - 1);
}

let keyElements = {}; // midi -> element

function buildKeyboard() {

    keyboardDiv.innerHTML = "";

    let whiteIndex = 0;

    for (let midi = START_MIDI; midi <= END_MIDI; midi++) {

        const note = midi % 12;
        const octave = Math.floor(midi / 12) - 1;

        if (!isBlack(midi)) {
            // WHITE KEY
            const key = document.createElement("div");
            key.className = "white-key";
            key.dataset.midi = midi;
            key.textContent = NOTE_NAMES[note];
            key.style.left = (whiteIndex * 40) + "px";

            keyboardDiv.appendChild(key);
            keyElements[midi] = key;

            whiteIndex++;

        } else {
            // BLACK KEY
            const key = document.createElement("div");
            key.className = "black-key";
            key.dataset.midi = midi;
            key.textContent = NOTE_NAMES[note];
            
            // Position black keys between whites
            const position = whiteIndex * 40 - 14;
            key.style.left = position + "px";

            keyboardDiv.appendChild(key);
            keyElements[midi] = key;
        }
    }

    // Set keyboard width
    keyboardDiv.style.width = (whiteIndex * 40) + "px";
}

buildKeyboard();

// ------------------------
//  WebSocket + MIDI
// ------------------------
let ws;
const noteNameDisplay = document.getElementById("noteName");

document.getElementById("connectBtn").onclick = () => {

    const room = document.getElementById("room").value;
    const keyboard = document.getElementById("keyboardNum").value;

    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        status.textContent = "Connected";
        ws.send(JSON.stringify({
            type: "join",
            role: "student",
            room,
            keyboard
        }));
    };

    ws.onerror = () => status.textContent = "WebSocket error";
    ws.onclose = () => status.textContent = "Disconnected";
};

// ------------------------
//  KEY PRESS HANDLERS
// ------------------------
function activateKey(midi) {
    const el = keyElements[midi];
    if (!el) return;

    if (isBlack(midi)) el.classList.add("active-black");
    else el.classList.add("active-white");

    setTimeout(() => {
        el.classList.remove("active-black");
        el.classList.remove("active-white");
    }, 150);
}

// Mouse play
keyboardDiv.addEventListener("mousedown", e => {
    const midi = e.target.dataset.midi;
    if (!mi
