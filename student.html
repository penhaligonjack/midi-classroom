<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Student – MIDI Classroom</title>
    <style>
        body { font-family: Arial; padding: 20px; }

        #keyboard {
            position: relative;
            width: 1400px;
            height: 220px;
            margin-top: 20px;
            user-select: none;
        }

        .white {
            width: 40px;
            height: 200px;
            background: #fff;
            border: 1px solid #333;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .white.active {
            background: #88c7ff;
        }

        .black {
            width: 26px;
            height: 120px;
            background: #000;
            position: absolute;
            margin-left: -13px;
            z-index: 2;
            border-radius: 0 0 4px 4px;
        }

        .black.active {
            background: #3399ff;
        }

        #status { margin-top: 10px; }
    </style>
</head>

<body>
    <h2>Student – MIDI Classroom</h2>

    <!-- Classroom -->
    <label>Choose Classroom:</label>
    <select id="room">
        <option value="77">Classroom 77</option>
        <option value="78">Classroom 78</option>
    </select>

    <br><br>

    <!-- Keyboard number -->
    <label>Your Keyboard Number:</label>
    <select id="keyboardNum">
        <script>
            for (let i = 1; i <= 15; i++) {
                document.write(`<option value="${i}">${i}</option>`);
            }
        </script>
    </select>

    <br><br>

    <!-- Volume -->
    <label>Volume: <span id="volLabel">80</span>%</label><br>
    <input id="volume" type="range" min="0" max="100" value="80">
    <br><br>

    <button id="connectBtn">Connect</button>
    <div id="status">Not connected</div>

    <!-- On-screen keyboard -->
    <div id="keyboard"></div>

    <script>
        /* ------------------------------------------------------
           AUDIO ENGINE
        ------------------------------------------------------*/
        let audioCtx = null;
        let masterGain = null;

        function initAudio() {
            if (audioCtx) return;

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = volume.value / 100;
            masterGain.connect(audioCtx.destination);
        }

        volume.oninput = () => {
            volLabel.textContent = volume.value;
            if (masterGain) masterGain.gain.value = volume.value / 100;
        };

        function midiToFreq(note) {
            return 440 * Math.pow(2, (note - 69) / 12);
        }

        function playLocal(note, velocity) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = "sine";
            osc.frequency.value = midiToFreq(note);

            gain.gain.value = velocity / 127;
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        /* ------------------------------------------------------
           ON-SCREEN KEYBOARD
        ------------------------------------------------------*/
        const keyboardDiv = document.getElementById("keyboard");
        const whiteNotes = [0, 2, 4, 5, 7, 9, 11];

        let keyElements = {};

        function buildKeyboard() {
            keyboardDiv.innerHTML = "";
            keyElements = {};

            let whiteIndex = 0;

            for (let midi = 21; midi <= 108; midi++) {
                const noteInOctave = midi % 12;
                const isWhite = whiteNotes.includes(noteInOctave);

                if (isWhite) {
                    const key = document.createElement("div");
                    key.className = "white";
                    key.dataset.note = midi;
                    key.style.left = (whiteIndex * 40) + "px";
                    keyboardDiv.appendChild(key);
                    keyElements[midi] = key;
                    whiteIndex++;
                } else {
                    const key = document.createElement("div");
                    key.className = "black";
                    key.dataset.note = midi;
                    key.style.left = (whiteIndex * 40 - 13) + "px";
                    keyboardDiv.appendChild(key);
                    keyElements[midi] = key;
                }
            }
        }
        buildKeyboard();

        /* ------------------------------------------------------
           WEBSOCKET + MIDI SEND
        ------------------------------------------------------*/
        let ws;

        function wsURL() {
            return (location.hostname === "localhost")
                ? "ws://localhost:8080"
                : "wss://" + window.location.host;
        }

        connectBtn.onclick = () => {
            initAudio();

            ws = new WebSocket(wsURL());

            ws.onopen = () => {
                status.textContent = "Connected";

                ws.send(JSON.stringify({
                    type: "join",
                    role: "student",
                    room: room.value,
                    keyboard: keyboardNum.value
                }));
            };

            ws.onerror = () => status.textContent = "WebSocket error";
            ws.onclose  = () => status.textContent = "Disconnected";
        };

        /* ------------------------------------------------------
           PLAY NOTE (clicking on-screen keys)
        ------------------------------------------------------*/
        function sendNoteOn(note) {
            playLocal(note, 100);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "midi",
                    midi: [144, note, 100],
                    keyboard: keyboardNum.value
                }));
            }
        }

        for (let note in keyElements) {
            const el = keyElements[note];

            el.onmousedown = () => {
                el.classList.add("active");
                sendNoteOn(parseInt(note));
            };

            el.onmouseup = () => {
                el.classList.remove("active");
            };

            el.onmouseleave = () => {
                el.classList.remove("active");
            };
        }
    </script>
</body>
</html>
