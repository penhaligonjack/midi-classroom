<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student — MIDI Classroom (61-key)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:12px; }
  .controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  label{ font-size:14px; }
  #keyboardWrap{ overflow-x:auto; border-top:1px solid #ddd; padding-top:12px; margin-top:12px; }
  #keyboard{ position:relative; height:calc(180px + 36px); user-select:none; }
  .white{ display:inline-block; width:40px; height:180px; border:1px solid #333; background:#fff; box-sizing:border-box; vertical-align:bottom; position:relative; }
  .white.active{ background:#d6f0ff; }
  .white .label{ position:absolute; bottom:-18px; left:4px; font-size:11px; }
  .black{ position:absolute; width:26px; height:120px; background:#111; border-radius:0 0 4px 4px; z-index:3; color:#fff; text-align:center; pointer-events:auto; }
  .black.active{ background:#66aaff; }
</style>
</head>
<body>
  <h2>Student — MIDI Classroom (61-key)</h2>

  <div class="controls">
    <label>Classroom:
      <select id="room"><option value="77">77</option><option value="78">78</option></select>
    </label>

    <label>Keyboard:
      <select id="keyboardNum"></select>
    </label>

    <label>Volume: <span id="volLabel">80</span>%</label>
    <input id="volume" type="range" min="0" max="100" value="80">
    <button id="connectBtn" class="small">Connect</button>
    <span id="status">Not connected</span>
  </div>

  <div id="keyboardWrap"><div id="keyboard"></div></div>

  <script>
  /* ---------- Config ---------- */
  const START_MIDI = 36; const END_MIDI = 96;
  const WHITE_STEPS = [0,2,4,5,7,9,11];
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  function wsURL(){
    if (location.protocol === 'file:') return 'ws://localhost:8080';
    return (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
  }

  /* ---------- DOM refs ---------- */
  const roomEl = document.getElementById('room');
  const keyboardNumEl = document.getElementById('keyboardNum');
  const connectBtn = document.getElementById('connectBtn');
  const statusEl = document.getElementById('status');
  const keyboardDiv = document.getElementById('keyboard');
  const volumeEl = document.getElementById('volume');
  const volLabel = document.getElementById('volLabel');

  for(let i=1;i<=15;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; keyboardNumEl.appendChild(o); }

  /* ---------- Audio ---------- */
  let audioCtx = null; let masterGain = null;
  const localVoices = new Map();

  function initAudio(){ if (audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = volumeEl.value/100; masterGain.connect(audioCtx.destination); }
  volumeEl.addEventListener('input', ()=> { volLabel.textContent = volumeEl.value; if (masterGain) masterGain.gain.setValueAtTime(volumeEl.value/100, audioCtx.currentTime || 0); });

  function midiToFreq(n){ return 440 * Math.pow(2, (n - 69)/12); }

  function playLocal(note, vel=100){
    initAudio();
    if (localVoices.has(note)) return;
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator(); osc.type='sine'; osc.frequency.value = midiToFreq(note);
    const g = audioCtx.createGain(); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime((vel/127)*0.3, now + 0.005);
    osc.connect(g); g.connect(masterGain); osc.start(now);
    localVoices.set(note, {osc,g});
  }
  function stopLocal(note){
    const v = localVoices.get(note); if(!v) return;
    const now = audioCtx.currentTime; v.gain.gain.setTargetAtTime(0.0001, now, 0.02); try{ v.osc.stop(now + 0.04);}catch(e){}; localVoices.delete(note);
  }

  /* ---------- Build keyboard (61 keys) ---------- */
  const keyElements = {};
  function isWhite(m){ return WHITE_STEPS.includes(m % 12); }

  function buildKeyboard(){
    keyboardDiv.innerHTML = '';
    const whiteNodes = [];
    for(let m=START_MIDI;m<=END_MIDI;m++){
      if (isWhite(m)){
        const el = document.createElement('div'); el.className='white'; el.dataset.midi=m;
        const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = NOTE_NAMES[m%12] + Math.floor(m/12 - 1);
        el.appendChild(lbl);
        keyboardDiv.appendChild(el);
        whiteNodes.push({m,el});
        keyElements[m] = el;
      }
    }
    keyboardDiv.style.width = (whiteNodes.length * 40) + 'px';
    // blacks
    for(let i=0;i<whiteNodes.length;i++){
      const leftWhite = whiteNodes[i];
      const candidate = leftWhite.m + 1; const mod = candidate % 12;
      if ([1,3,6,8,10].includes(mod) && candidate <= END_MIDI){
        const b = document.createElement('div'); b.className='black'; b.dataset.midi=candidate;
        b.style.left = (leftWhite.el.offsetLeft + 40 - 13) + 'px';
        keyboardDiv.appendChild(b);
        keyElements[candidate] = b;
      }
    }
    // pointer handlers
    Object.values(keyElements).forEach(el => { el.addEventListener('pointerdown', keyDown); el.addEventListener('pointerup', keyUp); el.addEventListener('pointerleave', keyUp); });
  }

  function highlightKey(n, on= true){
    const el = keyElements[n]; if(!el) return;
    if(on) el.classList.add(el.classList.contains('black') ? 'active' : 'active');
    else el.classList.remove('active');
  }

  /* ---------- WebSocket ---------- */
  let ws = null;
  connectBtn.addEventListener('click', ()=>{
    if (ws && ws.readyState === WebSocket.OPEN){ ws.close(); connectBtn.textContent='Connect'; statusEl.textContent='Disconnected'; return; }
    ws = new WebSocket(wsURL());
    ws.onopen = ()=> { statusEl.textContent='Connected'; connectBtn.textContent='Disconnect'; ws.send(JSON.stringify({ type:'join', role:'student', room: roomEl.value, keyboard: keyboardNumEl.value })); };
    ws.onmessage = (ev)=> {
      try{
        const obj = JSON.parse(ev.data);
        if (obj.type === 'play-from-host' && Array.isArray(obj.midi)){
          const [status,note,vel] = obj.midi;
          if ((status & 0xf0) === 0x90 && vel > 0) { playLocal(note, vel); highlightKey(note, true); }
          else { stopLocal(note); highlightKey(note, false); }
        }
      }catch(e){}
    };
    ws.onclose = ()=> { statusEl.textContent='Disconnected'; connectBtn.textContent='Connect'; };
    ws.onerror = ()=> statusEl.textContent='WebSocket error';
  });

  /* ---------- Send student MIDI to server & play locally ---------- */
  function sendStudentMidi(status,note,vel){
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(JSON.stringify({ type:'student-midi', room: roomEl.value, keyboard: keyboardNumEl.value, midi:[status,note,vel] }));
  }

  /* ---------- pointer handlers ---------- */
  const pointerMap = new Map();
  function keyDown(e){
    e.preventDefault();
    const midi = Number(this.dataset.midi);
    try{ this.setPointerCapture && this.setPointerCapture(e.pointerId);}catch(e){}
    pointerMap.set(e.pointerId,midi);
    // play locally and send to server
    playLocal(midi, 100);
    highlightKey(midi, true);
    sendStudentMidi(0x90, midi, 100);
  }
  function keyUp(e){
    e.preventDefault();
    const midi = Number(this.dataset.midi);
    try{ this.releasePointerCapture && this.releasePointerCapture(e.pointerId);}catch(e){}
    pointerMap.delete(e.pointerId);
    stopLocal(midi);
    highlightKey(midi, false);
    sendStudentMidi(0x80, midi, 0);
  }

  /* ---------- WebMIDI support ---------- */
  if (navigator.requestMIDIAccess){
    navigator.requestMIDIAccess().then(access => {
      for (let input of access.inputs.values()){
        input.onmidimessage = (ev) => {
          const status = ev.data[0] & 0xf0; const note = ev.data[1]; const vel = ev.data[2];
          if (status === 0x90 && vel > 0){ playLocal(note, vel); highlightKey(note, true); sendStudentMidi(0x90, note, vel); }
          else if (status === 0x80 || (status === 0x90 && vel === 0)){ stopLocal(note); highlightKey(note, false); sendStudentMidi(0x80, note, 0); }
        };
      }
    }).catch(()=>{ console.warn('No WebMIDI'); });
  }

  /* ---------- init ---------- */
  function init(){ buildKeyboard(); statusEl.textContent='Ready (not connected)'; document.addEventListener('pointerdown', ()=> { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, { once:true }); }
  init();
  </script>
</body>
</html>
