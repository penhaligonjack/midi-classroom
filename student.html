<!DOCTYPE html>
<html>
<head>
    <title>Student - MIDI Classroom</title>
</head>
<body>
    <h1>Student â€“ MIDI Classroom</h1>

    <button id="connect">Join Session</button>
    <p id="status">Not connected</p>

    <script>
        let ws;
        let audioCtx;

        // -----------------------------------------------------
        //           ACOUSTIC PIANO SOUND (same as host)
        // -----------------------------------------------------

        function playLocalPiano(midiMessage) {
            const [command, note, velocity] = midiMessage;
            if (command !== 144 && command !== 128) return;
            if (velocity === 0) return; // NoteOn with vel 0 = NoteOff

            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            const now = audioCtx.currentTime;
            const freq = 440 * Math.pow(2, (note - 69) / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.frequency.setValueAtTime(freq, now);
            osc.type = "sine";

            const vol = velocity / 127;

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + 0.01);
            gain.gain.linearRampToValueAtTime(vol * 0.6, now + 0.15);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + 2.0);

            osc.connect(gain).connect(audioCtx.destination);

            osc.start(now);
            osc.stop(now + 2.2);
        }

        // -----------------------------------------------------
        //           CONNECT TO WEBSOCKET (Railway)
        // -----------------------------------------------------

        document.getElementById("connect").onclick = async () => {

            ws = new WebSocket(`wss://${window.location.host}`);

            ws.onopen = async () => {
                document.getElementById("status").innerText = "Connected to server";

                // Students identify themselves
                ws.send(JSON.stringify({ type: "join", role: "student", room: "room1" }));

                await setupMIDI();
            };

            ws.onerror = (e) => {
                console.error("WS error", e);
            };
        };

        // -----------------------------------------------------
        //                  MIDI SETUP
        // -----------------------------------------------------

        async function setupMIDI() {
            if (!navigator.requestMIDIAccess) {
                alert("WebMIDI not supported in this browser.");
                return;
            }

            const access = await navigator.requestMIDIAccess();

            for (let input of access.inputs.values()) {
                input.onmidimessage = (msg) => {
                    const midiData = [...msg.data];

                    // 1) Play sound locally immediately
                    playLocalPiano(midiData);

                    // 2) Send note to host
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: "midi", data: midiData }));
                    }
                };
            }
        }
    </script>
</body>
</html>
