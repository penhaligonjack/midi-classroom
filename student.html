<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Student – MIDI Classroom</title>
<style>
    body { font-family: Arial; text-align: center; }

    #keyboard {
        user-select: none;
        position: relative;
        margin: 20px auto;
        height: 200px;
        width: fit-content;
    }

    .white-key, .black-key {
        display: inline-flex;
        justify-content: center;
        align-items: flex-end;
        font-size: 10px;
        cursor: pointer;
    }

    .white-key {
        width: 40px;
        height: 200px;
        border: 1px solid #333;
        background: white;
        position: relative;
        z-index: 1;
    }

    .black-key {
        width: 28px;
        height: 120px;
        background: black;
        color: white;
        position: absolute;
        top: 0;
        z-index: 2;
        border-radius: 0 0 3px 3px;
        text-align: center;
        padding-top: 5px;
    }

    .active-white { background: #ffdd88 !important; }
    .active-black { background: #bb8800 !important; }

    #status { margin-top: 10px; }
</style>
</head>
<body>

<h2>Student – MIDI Classroom</h2>

<label>Classroom:</label>
<select id="room">
    <option value="77">Classroom 77</option>
    <option value="78">Classroom 78</option>
</select>

<br><br>

<label>Keyboard Number:</label>
<select id="keyboardNum"></select>

<br><br>

<button id="connectBtn">Join Classroom</button>

<p id="status">Not connected</p>

<label>Volume: <span id="volLabel">80</span>%</label><br>
<input type="range" id="volume" min="0" max="100" value="80">

<h3>Last Note: <span id="noteName">(none)</span></h3>

<div id="keyboard"></div>

<script>
/* -----------------------------
   STATIC VALUES
------------------------------*/
const START_MIDI = 36; // C2
const END_MIDI   = 96; // C7 (61 keys)
const BLACKS = [1,3,6,8,10];

function isBlack(m) { return BLACKS.includes(m % 12); }

const NOTE_NAMES = [
    "C","C#/Db","D","D#/Eb","E","F",
    "F#/Gb","G","G#/Ab","A","A#/Bb","B"
];

function midiToName(m) {
    return NOTE_NAMES[m % 12] + (Math.floor(m/12) - 1);
}

/* -----------------------------
   BUILD KEYBOARD NUMBER DROPDOWN
------------------------------*/
const keyboardDrop = document.getElementById("keyboardNum");
for (let i = 1; i <= 15; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i;
    keyboardDrop.appendChild(opt);
}

/* -----------------------------
   AUDIO ENGINE
------------------------------*/
let audioCtx = null, gainNode = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        gainNode.gain.value = volume.value / 100;
    }
}

function playTone(midi, vel=100) {
    initAudio();
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    const freq = 440 * Math.pow(2, (midi - 69)/12);
    osc.frequency.value = freq;

    g.gain.value = (vel/127) * 0.6;

    osc.connect(g);
    g.connect(gainNode);

    osc.start();
    osc.stop(audioCtx.currentTime + 0.35);
}

volume.oninput = () => {
    volLabel.textContent = volume.value;
    if (gainNode) gainNode.gain.value = volume.value/100;
};

/* -----------------------------
   BUILD 61-KEY KEYBOARD
------------------------------*/
const keyboardDiv = document.getElementById("keyboard");
let keyElements = {};
function buildKeyboard() {

    keyboardDiv.innerHTML = "";
    let whiteIndex = 0;

    for (let midi = START_MIDI; midi <= END_MIDI; midi++) {

        if (!isBlack(midi)) {
            const k = document.createElement("div");
            k.className = "white-key";
            k.dataset.midi = midi;
            k.textContent = NOTE_NAMES[midi % 12];
            k.style.left = (whiteIndex * 40) + "px";

            keyboardDiv.appendChild(k);
            keyElements[midi] = k;

            whiteIndex++;
        } else {
            const k = document.createElement("div");
            k.className = "black-key";
            k.dataset.midi = midi;
            k.textContent = NOTE_NAMES[midi % 12];

            // Correct visual position of black keys
            k.style.left = (whiteIndex * 40 - 14) + "px";

            keyboardDiv.appendChild(k);
            keyElements[midi] = k;
        }
    }

    keyboardDiv.style.width = (whiteIndex * 40) + "px";
}

buildKeyboard();

/* -----------------------------
   KEY HIGHLIGHTING
------------------------------*/
function highlightKey(midi) {
    const el = keyElements[midi];
    if (!el) return;

    el.classList.add(isBlack(midi) ? "active-black" : "active-white");

    setTimeout(() => {
        el.classList.remove("active-white");
        el.classList.remove("active-black");
    }, 120);
}

/* -----------------------------
   WEBSOCKET
------------------------------*/
const status = document.getElementById("status");

const WS_URL = (location.hostname === "localhost")
    ? "ws://localhost:8080"
    : "wss://" + location.host;

let ws;

connectBtn.onclick = () => {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        status.textContent = "Connected";
        ws.send(JSON.stringify({
            type: "join",
            role: "student",
            room: room.value,
            keyboard: keyboardNum.value
        }));
    };

    ws.onclose = () => status.textContent = "Disconnected";
    ws.onerror = () => status.textContent = "WebSocket error";
};

/* -----------------------------
   MOUSE PLAY
------------------------------*/
keyboardDiv.addEventListener("mousedown", e => {
    const midi = Number(e.target.dataset.midi);
    if (!midi) return;

    playTone(midi);
    highlightKey(midi);
    noteName.textContent = midiToName(midi);

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "midi", midi: [144, midi, 100] }));
    }
});

/* -----------------------------
   MIDI KEYBOARD INPUT
------------------------------*/
if (navigator.requestMIDIAccess) {
    navigator.requestMIDIAccess().then(access => {
        for (let input of access.inputs.values()) {
            input.onmidimessage = msg => {
                const [cmd, note, vel] = msg.data;

                if (cmd === 144 && vel > 0) {
                    playTone(note, vel);
                    highlightKey(note);
                    noteName.textContent = midiToName(note);

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: "midi", midi: [144, note, vel] }));
                    }
                }
            };
        }
    });
}
</script>

</body>
</html>
