<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Piano</title>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }

    #status {
        font-weight: bold;
        margin-bottom: 15px;
    }

    canvas {
        border: 1px solid #444;
        cursor: pointer;
        user-select: none;
    }
</style>
</head>
<body>

<h2>Student Piano</h2>
<div id="status">Connecting...</div>

<canvas id="piano" width="700" height="180"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ============================================================
   SOCKET CONNECTION
============================================================ */
const socket = io();

socket.on("connect", () => {
    document.getElementById("status").innerText = "Connected";
});

function sendMidi(data) {
    socket.emit("midi", data);
}

/* ============================================================
   SIMPLE AUDIO ENGINE (students hear themselves)
============================================================ */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let oscillators = {};

function playLocalTone(midi) {
    const freq = 440 * Math.pow(2, (midi - 69) / 12);

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.frequency.value = freq;
    gain.gain.value = 0.2;

    osc.connect(gain).connect(audioCtx.destination);

    osc.start();

    oscillators[midi] = { osc, gain };
}

function stopLocalTone(midi) {
    if (oscillators[midi]) {
        oscillators[midi].gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03);
        oscillators[midi].osc.stop(audioCtx.currentTime + 0.05);
        delete oscillators[midi];
    }
}

/* ============================================================
   PIANO VISUAL + NOTE DETECTION
============================================================ */

const whiteKeys = [0, 2, 4, 5, 7, 9, 11];
const blackKeys = [1, 3, 6, 8, 10];

const TOTAL_KEYS = 25;          // C3 → C5 range
const START_MIDI = 48;

const piano = document.getElementById("piano");
const ctx = piano.getContext("2d");

const whiteKeyW = piano.width / TOTAL_KEYS;
const whiteKeyH = piano.height;
const blackKeyW = whiteKeyW * 0.6;
const blackKeyH = piano.height * 0.6;

let activeKeys = new Set();

/* -----------------------------
   Render keyboard
----------------------------- */
function drawKeyboard() {
    ctx.clearRect(0, 0, piano.width, piano.height);

    // White keys
    for (let i = 0; i < TOTAL_KEYS; i++) {
        const midi = START_MIDI + i;

        if (whiteKeys.includes(midi % 12)) {
            ctx.fillStyle = activeKeys.has(midi) ? "#ffe8a3" : "white";
            ctx.strokeStyle = "black";
            ctx.fillRect(i * whiteKeyW, 0, whiteKeyW, whiteKeyH);
            ctx.strokeRect(i * whiteKeyW, 0, whiteKeyW, whiteKeyH);
        }
    }

    // Black keys
    for (let i = 0; i < TOTAL_KEYS; i++) {
        const midi = START_MIDI + i;

        if (blackKeys.includes(midi % 12)) {
            ctx.fillStyle = activeKeys.has(midi) ? "#ffb347" : "black";
            ctx.fillRect(
                i * whiteKeyW - blackKeyW / 2,
                0,
                blackKeyW,
                blackKeyH
            );
        }
    }
}

drawKeyboard();

/* -----------------------------
   Mouse → MIDI note detection
----------------------------- */
function midiFromMouse(x, y) {
    // Black keys first
    for (let i = 0; i < TOTAL_KEYS; i++) {
        const midi = START_MIDI + i;
        if (!blackKeys.includes(midi % 12)) continue;

        const pos = i * whiteKeyW;
        if (
            x > pos - blackKeyW / 2 &&
            x < pos + blackKeyW / 2 &&
            y < blackKeyH
        ) {
            return midi;
        }
    }

    // Fall back to white key
    const whiteIndex = Math.floor(x / whiteKeyW);
    return START_MIDI + whiteIndex;
}

/* -----------------------------
   Mouse Events
----------------------------- */
let mouseDown = false;

piano.addEventListener("mousedown", (e) => {
    mouseDown = true;

    const r = piano.getBoundingClientRect();
    const midi = midiFromMouse(e.clientX - r.left, e.clientY - r.top);

    activeKeys.add(midi);
    sendMidi([144, midi, 100]);   // NOTE ON
    playLocalTone(midi);

    drawKeyboard();
});

piano.addEventListener("mouseup", () => {
    mouseDown = false;

    activeKeys.forEach((midi) => {
        sendMidi([128, midi, 0]); // NOTE OFF
        stopLocalTone(midi);
    });

    activeKeys.clear();
    drawKeyboard();
});

piano.addEventListener("mouseleave", () => {
    if (mouseDown) {
        activeKeys.forEach((midi) => {
            sendMidi([128, midi, 0]);
            stopLocalTone(midi);
        });
        activeKeys.clear();
        drawKeyboard();
    }
    mouseDown = false;
});

piano.addEventListener("mousemove", (e) => {
    if (!mouseDown) return;

    const r = piano.getBoundingClientRect();
    const midi = midiFromMouse(e.clientX - r.left, e.clientY - r.top);

    // If finger moved to a new key
    if (!activeKeys.has(midi)) {
        activeKeys.forEach((midiOld) => {
            sendMidi([128, midiOld, 0]);
            stopLocalTone(midiOld);
        });

        activeKeys.clear();
        activeKeys.add(midi);

        sendMidi([144, midi, 100]);
        playLocalTone(midi);

        drawKeyboard();
    }
});
</script>

</body>
</html>
