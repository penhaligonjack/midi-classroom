<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Student â€“ MIDI Classroom</title>
</head>
<body>
    <h2>Student Page</h2>

    <label>Room Name:</label>
    <input id="room" value="room1"><br><br>

    <label>Volume:</label>
    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8"><br><br>

    <button id="connectBtn">Join Room & Start MIDI</button>
    <p id="status">Not connected</p>

    <pre id="log" style="background:#f6f6f6;padding:8px;"></pre>

    <!-- SoundFont Piano -->
    <script src="https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_grand_piano-mp3.js"></script>

    <script>
        // Auto WebSocket selection
        const PROD_WS = `wss://${window.location.host}`;
        const LOCAL_WS = "ws://localhost:8080";

        function selectWebSocketUrl() {
            return (location.hostname === "localhost") ? LOCAL_WS : PROD_WS;
        }

        // UI elements
        const statusEl = document.getElementById("status");
        const logEl = document.getElementById("log");
        function log(...a) { logEl.textContent += a.join(" ") + "\n"; }
        function setStatus(s) { statusEl.textContent = s; }

        // WebAudio output
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        let piano = null;
        let masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.8;
        masterGain.connect(audioCtx.destination);

        // Load SoundFont into WebAudio polyphonic engine
        function loadPiano() {
            return new Promise(resolve => {
                piano = MIDI; // Soundfont library already loaded globally
                MIDI.setContext(audioCtx);
                resolve();
            });
        }

        let ws;

        document.getElementById("volume").oninput = (e) => {
            masterGain.gain.value = e.target.value;
        };

        document.getElementById("connectBtn").addEventListener("click", async () => {
            const room = document.getElementById("room").value;
            await audioCtx.resume();
            await loadPiano();

            const wsUrl = selectWebSocketUrl();
            ws = new WebSocket(wsUrl);

            setStatus("Connecting...");
            log("Using WebSocket:", wsUrl);

            ws.onopen = () => {
                setStatus("Connected");
                ws.send(JSON.stringify({ type: "join", role: "student", room }));
                setupMIDI();
            };

            ws.onerror = (e) => log("WS error:", e);
            ws.onclose = () => setStatus("Disconnected");
        });

        async function setupMIDI() {
            if (!navigator.requestMIDIAccess) {
                setStatus("WebMIDI not supported (use Chrome)");
                return;
            }

            try {
                const access = await navigator.requestMIDIAccess();
                setStatus("MIDI Ready");

                for (let input of access.inputs.values()) {
                    input.onmidimessage = (msg) => {
                        let [cmd, note, vel] = msg.data;

                        // Play locally (polyphonic)
                        if (cmd === 144 && vel > 0) piano.noteOn(0, note, vel / 127, 0);
                        if (cmd === 128 || (cmd === 144 && vel === 0)) piano.noteOff(0, note, 0);

                        // Send to host
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: "midi", data: [...msg.data] }));
                        }
                    };
                }
            } catch (e) {
                log("MIDI error:", e);
            }
        }
    </script>
</body>
</html>
