<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Student – MIDI Classroom</title>
</head>
<body>
    <h2>Student – MIDI Classroom</h2>

    <!-- ■■■ CLASSROOM SELECT ■■■ -->
    <label>Choose Classroom:</label>
    <select id="room">
        <option value="77">Classroom 77</option>
        <option value="78">Classroom 78</option>
    </select>
    <br><br>

    <!-- ■■■ KEYBOARD NUMBER SELECT ■■■ -->
    <label>Your Keyboard Number:</label>
    <select id="keyboard">
        <script>
            // Generate 1–15
            for (let i = 1; i <= 15; i++) {
                document.write(`<option value="${i}">Keyboard ${i}</option>`);
            }
        </script>
    </select>
    <br><br>

    <button id="connectBtn">Join Session</button>

    <p id="status">Not connected</p>

    <h3>Your Last Played Note</h3>
    <div id="noteDisplay" style="font-size:22px;font-weight:bold;">(none)</div>

    <script>
        // Auto WebSocket: production OR local
        const PROD_WS = `wss://${window.location.host}`;
        const LOCAL_WS = "ws://localhost:8080";

        function selectWebSocketUrl() {
            return (location.hostname === "localhost") ? LOCAL_WS : PROD_WS;
        }

        // UI references
        const statusEl = document.getElementById("status");
        const noteDisplay = document.getElementById("noteDisplay");

        function setStatus(s) { statusEl.textContent = s; }

        let ws;

        document.getElementById("connectBtn").onclick = async () => {
            const room = document.getElementById("room").value;
            const keyboard = document.getElementById("keyboard").value;

            const wsUrl = selectWebSocketUrl();
            ws = new WebSocket(wsUrl);

            ws.onopen = async () => {
                setStatus("Connected");

                // Inform host that a student joined + their keyboard number
                ws.send(JSON.stringify({
                    type: "join",
                    role: "student",
                    room,
                    keyboard
                }));

                await setupMIDI();
            };

            ws.onclose = () => setStatus("Disconnected");
            ws.onerror = () => setStatus("WebSocket error");
        };

        // Convert MIDI note numbers → C4, F#5 etc.
        function midiToName(n) {
            const names = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const note = names[n % 12];
            const octave = Math.floor(n / 12) - 1;
            return note + octave;
        }

        async function setupMIDI() {
            if (!navigator.requestMIDIAccess) {
                setStatus("WebMIDI not supported (use Chrome).");
                return;
            }

            try {
                const access = await navigator.requestMIDIAccess();
                setStatus("MIDI ready — play your keyboard!");

                for (let input of access.inputs.values()) {
                    input.onmidimessage = (msg) => {
                        const [cmd, note, vel] = msg.data;

                        // Show note name
                        if (cmd === 144 && vel > 0) {
                            noteDisplay.textContent = midiToName(note);
                        }

                        // Send raw MIDI to host
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: "midi",
                                data: msg.data
                            }));
                        }
                    };
                }
            } catch (err) {
                setStatus("Failed to get MIDI access");
            }
        }
    </script>
</body>
</html>
