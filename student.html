<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Student – MIDI Classroom</title>
</head>
<body>
    <h1>Student – MIDI Classroom</h1>

    <label>Classroom:</label>
    <select id="classroom">
        <option value="77">Classroom 77</option>
        <option value="78">Classroom 78</option>
    </select>
    <br><br>

    <label>Keyboard Number:</label>
    <select id="keyboard">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
    </select>

    <br><br>
    <button id="connectBtn">Join Classroom</button>
    <p id="status">Not connected</p>

    <h2>Your MIDI Activity</h2>
    <pre id="log" style="background:#eee;padding:10px;"></pre>

    <script>
        let ws;

        const log = (msg) => {
            document.getElementById("log").textContent += msg + "\n";
        };

        document.getElementById("connectBtn").onclick = async () => {
            const classroom = document.getElementById("classroom").value;
            const keyboard = parseInt(document.getElementById("keyboard").value);

            ws = new WebSocket(`wss://${window.location.host}`);

            ws.onopen = () => {
                document.getElementById("status").innerText = "Connected";

                ws.send(JSON.stringify({
                    type: "student-join",
                    classroom,
                    keyboard
                }));

                setupMIDI(classroom, keyboard);
            };

            ws.onclose = () => {
                document.getElementById("status").innerText = "Disconnected";
            };

            ws.onerror = () => {
                document.getElementById("status").innerText = "WebSocket error";
            };
        };

        async function setupMIDI(classroom, keyboard) {
            if (!navigator.requestMIDIAccess) {
                log("MIDI not supported in this browser.");
                return;
            }

            const midiAccess = await navigator.requestMIDIAccess();

            log("MIDI ready. Play your keyboard!");

            midiAccess.inputs.forEach((input) => {
                input.onmidimessage = (msg) => {
                    const [cmd, note, velocity] = msg.data;

                    // Only note-on messages (144) are sent
                    if (cmd === 144 && velocity > 0) {
                        log(`Note ${note} (velocity ${velocity})`);

                        ws.send(JSON.stringify({
                            type: "student-midi",
                            classroom,
                            keyboard,
                            note,
                            velocity
                        }));
                    }
                };
            });
        }
    </script>
</body>
</html>
