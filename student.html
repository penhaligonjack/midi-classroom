<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Student – MIDI Classroom</title>
</head>
<body>
  <h2>Student Page</h2>
  <label>Room Name:</label>
  <input id="room" placeholder="enter room" value="room1"><br><br>
  <button id="connectBtn">Join Room & Start MIDI</button>
  <p id="status">Not connected</p>
  <pre id="log" style="background:#f6f6f6;padding:8px;"></pre>

  <script>
    // === WebSocket URL (automatic for local + production) ===
    function selectWebSocketUrl() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      return `${protocol}://${location.host}/ws`;
    }

    // ====== UI helpers ======
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    function log(...args) { 
      console.log(...args);
      logEl.textContent += args.join(" ") + "\n";
    }

    function setStatus(s) {
      statusEl.innerText = s;
      log("STATUS:", s);
    }

    let ws;

    document.getElementById("connectBtn").addEventListener("click", async () => {
      const room = document.getElementById("room").value || "room1";
      const wsUrl = selectWebSocketUrl();

      setStatus("Connecting to " + wsUrl + " ...");
      log("Using WS URL:", wsUrl);

      ws = new WebSocket(wsUrl);

      ws.onopen = async () => {
        setStatus("Connected to server");
        ws.send(JSON.stringify({ type: "join", role: "student", room }));
        await setupMIDI();
      };

      ws.onclose = () => {
        setStatus("Disconnected");
        log("WS closed");
      };

      ws.onerror = (e) => {
        setStatus("WebSocket error");
        log("WS error", e);
      };
    });

    // ====== MIDI Setup ======
    async function setupMIDI() {
      if (!navigator.requestMIDIAccess) {
        setStatus("WebMIDI not supported (use Chrome desktop)");
        return;
      }

      try {
        const access = await navigator.requestMIDIAccess();
        setStatus("MIDI enabled — connect keyboard and play");

        // Listen to all MIDI input devices
        for (let input of access.inputs.values()) {
          input.onmidimessage = (msg) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({
                type: "midi",
                data: [...msg.data]
              }));
            }
          };
        }

        access.onstatechange = (ev) => {
          log("MIDI device change:", ev.port?.name);
        };

      } catch (err) {
        setStatus("MIDI Failed: " + err);
        log(err);
      }
    }
  </script>
</body>
</html>
