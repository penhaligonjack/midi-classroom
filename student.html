<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Student – MIDI Classroom</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding:16px; max-width:900px; margin:auto; }
    .row { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    #piano { display:block; position:relative; height:180px; margin-top:12px; user-select:none; }
    .white { width:40px; height:180px; border:1px solid #333; background:#fff; box-sizing:border-box; float:left; position:relative; }
    .white.active { background:#a3d8ff; }
    .black { width:26px; height:110px; background:#111; position:absolute; top:0; margin-left:-13px; border-radius:0 0 4px 4px; z-index:2; }
    .black.active { background:#66aaff; }
    label { display:block; margin-top:8px; }
    #log { background:#f6f6f6; padding:8px; height:90px; overflow:auto; white-space:pre-wrap; }
    .controls { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <h1>Student — MIDI Classroom</h1>

  <div class="row">
    <label>Classroom:</label>
    <select id="room">
      <option value="77">77</option>
      <option value="78">78</option>
    </select>

    <label>Your keyboard:</label>
    <select id="keyboard">
      <!-- generated by script -->
    </select>

    <button id="connectBtn">Join & Start MIDI</button>
    <span id="status" style="margin-left:12px;">Not connected</span>
  </div>

  <div class="row">
    <label>Volume: <span id="volPct">80%</span></label>
    <input id="volume" type="range" min="0" max="100" value="80" style="width:240px;">
  </div>

  <div>
    <strong>Last note:</strong> <span id="noteDisplay">(none)</span>
  </div>

  <div id="piano" aria-hidden="true"></div>

  <h3>Activity log</h3>
  <pre id="log"></pre>

<script>
/* ===== CONFIG ===== */
function wsUrl(){
  // Railway provides wss host; local dev uses ws://localhost:3000
  if (location.hostname === "localhost" || location.protocol === "file:") return "ws://localhost:3000";
  return `wss://${window.location.host}`;
}

/* ===== UI refs ===== */
const connectBtn = document.getElementById('connectBtn');
const statusEl = document.getElementById('status');
const roomEl = document.getElementById('room');
const kbEl = document.getElementById('keyboard');
const volEl = document.getElementById('volume');
const volPct = document.getElementById('volPct');
const noteDisplay = document.getElementById('noteDisplay');
const logEl = document.getElementById('log');
const pianoEl = document.getElementById('piano');

function log(...args){ logEl.textContent += args.join(' ') + "\n"; logEl.scrollTop = logEl.scrollHeight; }

/* ===== populate keyboard select 1-15 ===== */
for (let i=1;i<=15;i++){
  const o = document.createElement('option'); o.value = i; o.textContent = i; kbEl.appendChild(o);
}

/* ===== WebAudio (student local synth) ===== */
let audioCtx = null;
let masterGain = null;
const voices = new Map(); // note -> {osc1, osc2, gain}

function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = Number(volEl.value)/100;
  masterGain.connect(audioCtx.destination);
}
volEl.addEventListener('input', () => {
  volPct.textContent = Math.round(Number(volEl.value)) + '%';
  if (masterGain) masterGain.gain.setValueAtTime(Number(volEl.value)/100, audioCtx.currentTime || 0);
});

/* ===== On-screen piano build (C3 -> C6) ===== */
const whiteSteps = [0,2,4,5,7,9,11];
const noteToKey = {}; // midiNote -> element
function buildPiano(){
  pianoEl.innerHTML = '';
  const start = 48; // C3
  const end = 84;   // C6
  // create white keys in order, but we also need to position black keys absolutely
  let whiteIndex = 0;
  for (let n = start; n <= end; n++){
    const isWhite = whiteSteps.includes(n % 12);
    if (isWhite){
      const key = document.createElement('div');
      key.className = 'white';
      key.dataset.note = n;
      key.style.left = (whiteIndex * 40) + 'px';
      pianoEl.appendChild(key);
      noteToKey[n] = key;
      whiteIndex++;
    } else {
      const key = document.createElement('div');
      key.className = 'black';
      key.dataset.note = n;
      // compute left offset: for black keys we position between white keys
      key.style.left = ( (whiteIndex-1) * 40 + 30 ) + 'px'; // tuned visually
      pianoEl.appendChild(key);
      noteToKey[n] = key;
    }
  }
}
buildPiano();

function highlightKey(note, on){
  const el = noteToKey[note];
  if (!el) return;
  if (on) el.classList.add('active'); else el.classList.remove('active');
}

/* ===== MIDI name helper ===== */
function midiToName(n){
  const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  return names[n % 12] + (Math.floor(n / 12) - 1);
}

/* ===== Student synth: polyphonic simple piano-ish ===== */
function startLocalNote(note, velocity){
  initAudio();
  if (voices.has(note)) return;
  const now = audioCtx.currentTime;
  const freq = 440 * Math.pow(2, (note - 69) / 12);

  const osc1 = audioCtx.createOscillator();
  osc1.type = 'triangle';
  osc1.frequency.value = freq;

  const osc2 = audioCtx.createOscillator();
  osc2.type = 'sawtooth';
  osc2.frequency.value = freq * 2.0;

  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = 800 + (velocity/127) * 3000;

  const gain = audioCtx.createGain();
  const peak = 0.25 * (velocity/127);
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(peak, now + 0.005);
  gain.gain.linearRampToValueAtTime(peak * 0.6, now + 0.12);

  osc1.connect(filter);
  osc2.connect(filter);
  filter.connect(gain);
  gain.connect(masterGain);

  osc1.start(now);
  osc2.start(now);

  voices.set(note, {osc1, osc2, gain});
}

function stopLocalNote(note){
  if (!audioCtx) return;
  const v = voices.get(note);
  if (!v) return;
  const now = audioCtx.currentTime;
  v.gain.gain.setTargetAtTime(0.0001, now, 1.2);
  try { v.osc1.stop(now + 1.6); v.osc2.stop(now + 1.6); } catch(e){}
  setTimeout(()=> voices.delete(note), 2000);
}

/* ===== WebSocket & MIDI wiring ===== */
let ws = null;

connectBtn.addEventListener('click', async () => {
  const classroom = roomEl.value;
  const keyboard = kbEl.value;

  // resume audio context on user gesture
  try { await (audioCtx ? audioCtx.resume() : (audioCtx = null)); } catch(e){}
  initAudio();

  ws = new WebSocket(wsUrl());
  setStatus('Connecting to ' + wsUrl());

  ws.onopen = () => {
    setStatus('Connected');
    ws.send(JSON.stringify({ type: 'student-join', classroom, keyboard }));
    setupMIDI(classroom, keyboard);
  };

  ws.onclose = () => setStatus('Disconnected');
  ws.onerror = (e) => { setStatus('WS error'); log('WS error', e); };
});

function setStatus(s){ statusEl.textContent = s; }

/* Setup WebMIDI to play locally and send to host */
async function setupMIDI(classroom, keyboard){
  if (!navigator.requestMIDIAccess){
    log('WebMIDI not supported — use Chrome desktop');
    return;
  }
  const access = await navigator.requestMIDIAccess();
  setStatus('MIDI ready — play keyboard');

  access.inputs.forEach(input => {
    input.onmidimessage = (ev) => {
      const [status, note, velocity] = ev.data;
      const cmd = status & 0xf0;

      // Note on
      if (cmd === 0x90 && velocity > 0){
        // local sound
        startLocalNote(note, velocity);
        highlightKey(note, true);
        noteDisplay.textContent = midiToName(note);

        // send to server
        if (ws && ws.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({
            type: 'student-midi',
            classroom,
            keyboard: Number(keyboard),
            note,
            velocity
          }));
        }
      }

      // Note off
      if (cmd === 0x80 || (cmd === 0x90 && velocity === 0)){
        stopLocalNote(note);
        highlightKey(note, false);
      }
    };
  });

  access.onstatechange = (ev) => log('MIDI device change: ' + (ev.port && ev.port.name));
}
</script>
</body>
</html>
