<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Host – MIDI Classroom (Recording)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:16px; max-width:1100px; margin:auto; }
    .row { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .studentBox { border:1px solid #bbb; padding:12px; border-radius:8px; background:#fafafa; margin-bottom:10px; position:relative; }
    .studentHeader { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .note { font-weight:600; font-size:18px; }
    .flash { animation: flashbg 140ms linear; }
    @keyframes flashbg { from { background: #fff3d9 } to { background: #fafafa } }
    button { padding:6px 10px; border-radius:6px; cursor:pointer; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    .small { font-size:13px; padding:4px 8px; }
    #studentArea { margin-top:16px; }
    .meta { color:#666; font-size:13px; }
  </style>

  <!-- Lamejs for MP3 encoding -->
  <script src="https://unpkg.com/lamejs@1.2.0/lame.min.js"></script>
</head>
<body>
  <h1>Host — MIDI Classroom (Record per student)</h1>

  <div class="row">
    <label>Classroom:</label>
    <select id="room">
      <option value="77">77</option>
      <option value="78">78</option>
    </select>

    <button id="connectBtn">Start Hosting</button>

    <label>Volume: <span id="volLabel">85</span>%</label>
    <input id="volume" type="range" min="0" max="100" value="85" style="width:220px">
    <span id="status" style="margin-left:12px;">Not connected</span>
  </div>

  <div id="studentArea"></div>

<script>
/* ========= Configuration & helpers ========= */
const PROD_WS = `wss://${window.location.host}`;
const LOCAL_WS = "ws://localhost:8080";
function wsUrl(){ return (location.hostname === "localhost" || location.protocol === "file:") ? LOCAL_WS : PROD_WS; }

const studentArea = document.getElementById('studentArea');
const statusEl = document.getElementById('status');
const volSlider = document.getElementById('volume');
const volLabel = document.getElementById('volLabel');

function setStatus(s){ statusEl.textContent = s; }

/* ========= Audio / synth / per-student routing ========= */
let audioCtx = null;
let masterGain = null;

// Map keyboardId (string/number) => student object
// student = {
//   keyboard: "1",
//   boxEl, noteEl, mediaDest, mediaRecorder, recordedChunks: [], isRecording,
//   voices: Map(note => {osc1, osc2, gainNode, stopTimer, release})
// }
const students = new Map();

function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = Number(volSlider.value) / 100;
  masterGain.connect(audioCtx.destination);
}

volSlider.addEventListener('input', () => {
  volLabel.innerText = volSlider.value;
  if (masterGain) masterGain.gain.setValueAtTime(Number(volSlider.value)/100, audioCtx.currentTime || 0);
});

/* create UI box & per-student audio graph */
function createStudent(keyboard) {
  if (students.has(keyboard)) return students.get(keyboard);

  // Dom box
  const box = document.createElement('div');
  box.className = 'studentBox';
  box.id = 'student_' + keyboard;

  box.innerHTML = `
    <div class="studentHeader">
      <div>
        <strong>Keyboard ${keyboard}</strong>
        <div class="meta">ID: ${keyboard}</div>
      </div>
      <div>
        <span class="note" id="note_${keyboard}">(none)</span>
      </div>
    </div>
    <div class="controls">
      <button class="small startRec" data-key="${keyboard}">Start Recording</button>
      <button class="small stopRec" data-key="${keyboard}" disabled>Stop & Download MP3</button>
