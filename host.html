<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Host — MIDI Classroom (61-key)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --white-w:40px; --white-h:180px; --black-w:26px; --black-h:120px; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:12px; }
  h2{ margin:6px 0 12px 0; }
  .topbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  label{ font-size:14px; }
  select,input[type="range"],button{ padding:6px 8px; }
  #status{ margin-left:8px; font-weight:bold; }
  #hostKeyboardWrap{ overflow-x:auto; border-top:1px solid #ddd; padding-top:12px; margin-top:12px; }
  #hostKeyboard{ position:relative; height: calc(var(--white-h) + 36px); user-select:none; }
  .white { display:inline-block; width:var(--white-w); height:var(--white-h); border:1px solid #333; background:#fff; box-sizing:border-box; vertical-align:bottom; position:relative; }
  .white.active{ background:#d6f0ff; }
  .white .label{ position:absolute; bottom:-18px; left:4px; font-size:11px; color:#111; user-select:none; }
  .black { position:absolute; width:var(--black-w); height:var(--black-h); background:#111; border-radius:0 0 4px 4px; z-index:3; color:#fff; text-align:center; pointer-events:auto; }
  .black .sharp { display:block; font-weight:700; margin-top:6px; font-size:12px; }
  .black .flat { display:block; font-size:11px; margin-top:2px; opacity:0.9; }
  .black.active{ background:#66aaff; }
  .studentList { margin-top:18px; display:flex; flex-direction:column; gap:12px; }
  .studentBox { padding:10px; border-radius:8px; border:1px solid #ccc; background:#fafafa; display:flex; gap:12px; align-items:flex-start; }
  .studentHeader { display:flex; flex-direction:column; gap:6px; }
  .studentControls{ display:flex; gap:8px; align-items:center; }
  .miniKeyboard { overflow:auto; margin-top:8px; border-top:1px dashed #eee; padding-top:8px; flex:1; }
  .small{ font-size:13px; padding:6px 8px; }
  .muted { opacity:0.35; }
</style>
</head>
<body>
  <h2>Host — MIDI Classroom (61-key)</h2>

  <div class="topbar">
    <label>Classroom:
      <select id="room"><option value="77">77</option><option value="78">78</option></select>
    </label>

    <button id="connectBtn" class="small">Connect</button>
    <span id="status">Not connected</span>

    <label style="margin-left:12px">Host Volume:
      <input id="hostVolume" type="range" min="0" max="100" value="90" style="vertical-align:middle;">
    </label>
  </div>

  <div style="margin-top:12px;">
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
      <div>
        <strong>Send host audio to:</strong>
        <div id="targetList" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;"></div>
      </div>
      <div style="margin-left:auto;">
        <button id="selectAll" class="small">Select All</button>
        <button id="clearTargets" class="small">Clear</button>
      </div>
    </div>

    <div id="hostKeyboardWrap">
      <div id="hostKeyboard"></div>
    </div>
  </div>

  <div style="margin-top:18px; font-weight:700;">Connected Students</div>
  <div id="studentContainer" class="studentList"></div>

<script>
/* ---------- Config ---------- */
const START_MIDI = 36; // C2
const END_MIDI   = 96; // C7 (61 keys)
const WHITE_STEPS = [0,2,4,5,7,9,11];
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function wsURL(){
  if (location.protocol === 'file:') return 'ws://localhost:8080';
  // server runs on same host & port as served pages
  return (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
}

/* ---------- UI refs ---------- */
const roomEl = document.getElementById('room');
const connectBtn = document.getElementById('connectBtn');
const statusEl = document.getElementById('status');
const hostKeyboardDiv = document.getElementById('hostKeyboard');
const targetListDiv = document.getElementById('targetList');
const studentContainer = document.getElementById('studentContainer');
const hostVolumeEl = document.getElementById('hostVolume');
const selectAllBtn = document.getElementById('selectAll');
const clearTargetsBtn = document.getElementById('clearTargets');

let ws = null;

/* ---------- Audio ---------- */
let audioCtx = null;
let masterGain = null;
function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = hostVolumeEl.value / 100;
  masterGain.connect(audioCtx.destination);
}
hostVolumeEl.addEventListener('input', ()=> {
  if (masterGain) masterGain.gain.setValueAtTime(hostVolumeEl.value/100, audioCtx.currentTime || 0);
});

/* polyphony stores */
const voices = new Map(); // sourceKey -> Map(note -> {osc,gain})

function playLocal(sourceKey, note, vel=100, volumeMultiplier=1.0){
  initAudio();
  if (!voices.has(sourceKey)) voices.set(sourceKey, new Map());
  const map = voices.get(sourceKey);
  if (map.has(note)) return;
  const freq = 440 * Math.pow(2,(note-69)/12);
  const osc = audioCtx.createOscillator(); osc.type='sine'; osc.frequency.value = freq;
  const g = audioCtx.createGain(); g.gain.value = 0;
  osc.connect(g); g.connect(masterGain);
  const vm = Math.max(0.01, (vel/127) * 0.4 * volumeMultiplier);
  g.gain.linearRampToValueAtTime(vm, audioCtx.currentTime + 0.002);
  osc.start();
  map.set(note, {osc,g});
}
function stopLocal(sourceKey, note){
  const map = voices.get(sourceKey); if (!map) return;
  const v = map.get(note); if (!v) return;
  try { v.gain.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.02); v.osc.stop(audioCtx.currentTime + 0.05); } catch(e){}
  map.delete(note);
}

/* ---------- Host keyboard build ---------- */
const whiteKeyW = 40, whiteKeyH = 180, blackKeyW = 26, blackKeyH = 120;
const keys = {}; // midi -> {el,isWhite}

function buildKeyboard(container){
  container.innerHTML = '';
  const whites = [];
  for(let m=START_MIDI;m<=END_MIDI;m++){
    const step = m % 12;
    const isWhite = WHITE_STEPS.includes(step);
    if(isWhite){
      const el = document.createElement('div'); el.className='white'; el.dataset.midi=m;
      const label = document.createElement('div'); label.className='label'; label.textContent = NOTE_NAMES[m%12] + Math.floor(m/12 - 1);
      el.appendChild(label);
      container.appendChild(el);
      whites.push({m,el});
      keys[m] = {el,isWhite:true};
    } else {
      keys[m] = {el:null,isWhite:false};
    }
  }
  container.style.width = (whites.length * whiteKeyW) + 'px';
  container.style.position = 'relative';
  // blacks
  for(let i=0;i<whites.length;i++){
    const leftWhite = whites[i];
    const candidate = leftWhite.m + 1;
    const mod = candidate % 12;
    if([1,3,6,8,10].includes(mod) && candidate <= END_MIDI){
      const b = document.createElement('div'); b.className='black'; b.dataset.midi=candidate;
      const sharp = document.createElement('span'); sharp.className='sharp'; sharp.textContent = NOTE_NAMES[candidate%12];
      const flat = document.createElement('span'); flat.className='flat'; flat.textContent = NOTE_NAMES[(candidate-1)%12] + 'b';
      b.appendChild(sharp); b.appendChild(flat);
      const left = leftWhite.el.offsetLeft + whiteKeyW - (blackKeyW/2);
      b.style.left = left + 'px';
      container.appendChild(b);
      keys[candidate].el = b;
    }
  }
  // attach host pointer handlers
  Object.entries(keys).forEach(([k,v])=>{ if(!v.el) return; v.el.addEventListener('pointerdown', hostKeyDown); v.el.addEventListener('pointerup', hostKeyUp); v.el.addEventListener('pointerleave', hostKeyUp); });
}

const pointerSet = new Set();
function hostKeyDown(e){
  e.preventDefault();
  const midi = Number(this.dataset.midi);
  try{ this.setPointerCapture && this.setPointerCapture(e.pointerId); }catch(e){}
  pointerSet.add(`${e.pointerId}:${midi}`);
  this.classList.add('active');
  // host hears own play
  playLocal('host', midi, 100, 1.0);
  // send to selected targets
  sendHostMidi(0x90, midi, 100);
}
function hostKeyUp(e){
  e.preventDefault();
  const midi = Number(this.dataset.midi);
  pointerSet.forEach(tok => { if(tok.endsWith(':'+midi)) pointerSet.delete(tok); });
  try{ this.releasePointerCapture && this.releasePointerCapture(e.pointerId); }catch(e){}
  this.classList.remove('active');
  stopLocal('host', midi);
  sendHostMidi(0x80, midi, 0);
}

/* ---------- Students UI ---------- */
const students = new Map(); // keyboardId -> {box,keyboardDiv,monitoring,muted,volEl}

function ensureTargetCheckbox(k){
  if (targetListDiv.querySelector(`[data-k='${k}']`)) return;
  const label = document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.k = k; cb.value = k;
  label.appendChild(cb); label.appendChild(document.createTextNode('K'+k));
  targetListDiv.appendChild(label);
}

function removeTargetCheckbox(k){
  const el = targetListDiv.querySelector(`[data-k='${k}']`);
  if (el && el.parentElement) el.parentElement.remove();
}

function addStudent(k){
  if (students.has(k)) return;
  ensureTargetCheckbox(k);
  const box = document.createElement('div'); box.className='studentBox'; box.id='student_'+k;
  const hdr = document.createElement('div'); hdr.className='studentHeader';
  hdr.innerHTML = `<div><strong>Keyboard ${k}</strong><div id="lastnote_${k}" class="meta">Last: (none)</div></div>`;
  const ctrls = document.createElement('div'); ctrls.className='studentControls';
  const monitorBtn = document.createElement('button'); monitorBtn.className='small'; monitorBtn.textContent='Monitor';
  monitorBtn.onclick = ()=> toggleMonitor(k);
  const muteBtn = document.createElement('button'); muteBtn.className='small'; muteBtn.textContent='Mute';
  muteBtn.onclick = ()=> toggleMute(k);
  const vol = document.createElement('input'); vol.type='range'; vol.min=0; vol.max=100; vol.value=90;
  vol.oninput = ()=> { const s = students.get(k); if(s) s.volume = vol.value/100; };
  ctrls.appendChild(monitorBtn); ctrls.appendChild(muteBtn); ctrls.appendChild(vol);
  hdr.appendChild(ctrls);
  box.appendChild(hdr);
  const mini = document.createElement('div'); mini.className='miniKeyboard'; mini.style.width='100%';
  // build small visual keyboard
  const kb = document.createElement('div'); kb.style.position='relative'; kb.style.height=(whiteKeyH+36)+'px';
  buildStudentMiniKeyboard(kb, k);
  mini.appendChild(kb); box.appendChild(mini);
  studentContainer.appendChild(box);
  students.set(k, { keyboard:k, box, keyboardDiv:kb, monitor:false, muted:false, volume: vol.value/100, monitorBtn, muteBtn });
}

function removeStudent(k){
  if (!students.has(k)) return;
  const s = students.get(k);
  s.box.remove();
  students.delete(k);
  removeTargetCheckbox(k);
}

function toggleMonitor(k){
  const s = students.get(k); if(!s) return;
  s.monitor = !s.monitor;
  s.monitorBtn.textContent = s.monitor ? 'Unmonitor' : 'Monitor';
}
function toggleMute(k){
  const s = students.get(k); if(!s) return;
  s.muted = !s.muted;
  s.muteBtn.textContent = s.muted ? 'Unmute' : 'Mute';
}

function buildStudentMiniKeyboard(container, k){
  container.innerHTML = '';
  const whiteNodes = [];
  for(let m=START_MIDI;m<=END_MIDI;m++){
    const step = m % 12; const isWhite = WHITE_STEPS.includes(step);
    if(isWhite){
      const el = document.createElement('div'); el.className='white'; el.style.width=whiteKeyW+'px'; el.style.height=whiteKeyH+'px';
      el.dataset.midi = m; const lbl = document.createElement('div'); lbl.className='label'; lbl.style.bottom='-18px'; lbl.textContent = NOTE_NAMES[m%12]+Math.floor(m/12-1); el.appendChild(lbl);
      container.appendChild(el); whiteNodes.push({m,el});
    }
  }
  container.style.width = (whiteNodes.length*whiteKeyW)+'px';
  for(let i=0;i<whiteNodes.length;i++){
    const leftWhite = whiteNodes[i]; const candidate = leftWhite.m + 1; const mod = candidate%12;
    if([1,3,6,8,10].includes(mod) && candidate<=END_MIDI){
      const b = document.createElement('div'); b.className='black'; b.dataset.midi=candidate;
      b.style.left = (leftWhite.el.offsetLeft + whiteKeyW - (blackKeyW/2)) + 'px'; container.appendChild(b);
    }
  }
}

/* ---------- Host -> server send ---------- */
function getSelectedTargets(){
  return Array.from(targetListDiv.querySelectorAll('input[type=checkbox]')).filter(cb => cb.checked).map(cb => cb.value);
}
function sendHostMidi(status,note,vel){
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  const targets = getSelectedTargets();
  if (targets.length === 0) return;
  ws.send(JSON.stringify({ type:'host-midi', room: roomEl.value, targets, midi:[status,note,vel] }));
}

/* ---------- Server message handling ---------- */
function handleServerMsg(obj){
  if (!obj || !obj.type) return;
  if (obj.type === 'student-join'){
    addStudent(String(obj.keyboard));
  } else if (obj.type === 'student-leave'){
    removeStudent(String(obj.keyboard));
  } else if (obj.type === 'midi-from-student'){
    const kb = String(obj.keyboard);
    const midi = obj.midi; // [status,note,vel]
    if (!midi || midi.length < 3) return;
    const [statusByte, note, vel] = midi;
    // ensure student exists
    if (!students.has(kb)) addStudent(kb);
    // update last note
    const lastEl = document.getElementById('lastnote_'+kb);
    if (lastEl) lastEl.textContent = `Last: ${NOTE_NAMES[note%12]}${Math.floor(note/12 -1)} (v:${vel})`;
    // highlight mini-key in student's keyboard
    const s = students.get(kb);
    if (s && s.keyboardDiv){
      const el = s.keyboardDiv.querySelector(`[data-midi='${note}']`);
      if (el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),120); }
    }
    // If host is monitoring that student, play locally (using that student's volume)
    if (s && s.monitor && !s.muted){
      playLocal('student:'+kb, note, vel, s.volume || 0.9);
    }
  } else if (obj.type === 'presence' && Array.isArray(obj.students)){
    // initial presence
    obj.students.forEach(k => { if (!students.has(String(k))) addStudent(String(k)); });
  }
}

/* ---------- WebSocket connect ---------- */
connectBtn.addEventListener('click', ()=>{
  if (ws && ws.readyState === WebSocket.OPEN){ ws.close(); connectBtn.textContent='Connect'; statusEl.textContent='Disconnected'; return; }
  ws = new WebSocket(wsURL());
  ws.onopen = ()=> {
    connectBtn.textContent='Disconnect'; statusEl.textContent='Connected';
    ws.send(JSON.stringify({ type:'join', role:'host', room: roomEl.value }));
    // ask for presence
    ws.send(JSON.stringify({ type:'list-students', room: roomEl.value }));
  };
  ws.onmessage = ev => {
    try { const obj = JSON.parse(ev.data); handleServerMsg(obj); } catch(e){ console.warn('WS parse', e); }
  };
  ws.onclose = ()=> { connectBtn.textContent='Connect'; statusEl.textContent='Disconnected'; };
  ws.onerror = ()=> { statusEl.textContent='WebSocket error'; };
});

/* ---------- MIDI input for host ---------- */
if (navigator.requestMIDIAccess){
  navigator.requestMIDIAccess().then(access=>{
    for (let input of access.inputs.values()){
      input.onmidimessage = (ev) => {
        const status = ev.data[0] & 0xf0;
        const note = ev.data[1]; const vel = ev.data[2];
        if (status === 0x90 && vel > 0){
          // highlight host key
          const el = hostKeyboardDiv.querySelector(`[data-midi='${note}']`);
          if (el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),120); }
          playLocal('host', note, vel, 1.0);
          sendHostMidi(status, note, vel);
        } else if (status === 0x80 || (status === 0x90 && vel === 0)){
          stopLocal('host', note);
          sendHostMidi(0x80, note, 0);
        }
      };
    }
  }).catch(()=>console.warn('MIDI not available for host'));
}

/* ---------- helpers ---------- */
function statusMsg(t){ statusEl.textContent = t; }
document.getElementById('selectAll').addEventListener('click', ()=> { Array.from(targetListDiv.querySelectorAll('input[type=checkbox]')).forEach(cb=>cb.checked=true); });
document.getElementById('clearTargets').addEventListener('click', ()=> { Array.from(targetListDiv.querySelectorAll('input[type=checkbox]')).forEach(cb=>cb.checked=false); });

/* ---------- init ---------- */
(function init(){
  buildKeyboard(hostKeyboardDiv);
  statusMsg('Ready (not connected)');
  document.addEventListener('pointerdown', ()=> { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, { once:true });
})();
</script>
</body>
</html>
