<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Host – MIDI Classroom</title>

<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .studentBox {
        border: 2px solid #333;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #f3f3f3;
        transition: background 0.15s;
    }
    .flash {
        background: #ffe6a3 !important;
    }
</style>
</head>
<body>

<h2>Host – MIDI Classroom</h2>

<!-- Volume Control -->
<div>
    <label>Volume: <span id="volLabel">80</span>%</label><br>
    <input id="volume" type="range" min="0" max="100" value="80" />
</div>

<p id="status">Connecting…</p>

<h3>Student Activity</h3>
<div id="studentArea"></div>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>

<script>
/* =============================================================
   CONNECT TO SERVER
============================================================= */
const socket = io();

socket.on("connect", () => {
    document.getElementById("status").innerText = "Connected to server";
});

/* =============================================================
   STUDENT UI BOXES
============================================================= */
const studentArea = document.getElementById("studentArea");
const students = new Map();

function getStudentBox(studentId) {
    if (students.has(studentId)) return students.get(studentId);

    const box = document.createElement("div");
    box.className = "studentBox";
    box.id = "student_" + studentId;

    box.innerHTML = `
        <h3>Student ${studentId}</h3>
        <div>Last note: <span id="note_${studentId}">(none)</span></div>
    `;

    studentArea.appendChild(box);
    students.set(studentId, box);

    return box;
}

/* =============================================================
   HOST AUDIO ENGINE
============================================================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let volumeGain = audioCtx.createGain();
volumeGain.gain.value = 0.8;
volumeGain.connect(audioCtx.destination);

// Volume slider
const volSlider = document.getElementById("volume");
const volLabel  = document.getElementById("volLabel");

volSlider.oninput = () => {
    const vol = volSlider.value / 100;
    volumeGain.gain.value = vol;
    volLabel.innerText = volSlider.value;
};

/* MIDI Utilities */
function midiToFreq(note) {
    return 440 * Math.pow(2, (note - 69) / 12);
}

function midiToName(n) {
    const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    return names[n % 12] + (Math.floor(n / 12) - 1);
}

/* Polyphonic Voice Storage */
let activeVoices = {};  // { studentId: { note: {osc, gain} } }

/* Start note */
function playNote(studentId, midi, vel) {
    if (!activeVoices[studentId]) activeVoices[studentId] = {};

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";  
    osc.frequency.value = midiToFreq(midi);

    gain.gain.value = (vel / 127) * 0.5;  
    osc.connect(gain).connect(volumeGain);

    osc.start();

    activeVoices[studentId][midi] = { osc, gain };
}

/* Stop note */
function stopNote(studentId, midi) {
    if (
        activeVoices[studentId] &&
        activeVoices[studentId][midi]
    ) {
        const voice = activeVoices[studentId][midi];
        voice.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03);
        voice.osc.stop(audioCtx.currentTime + 0.05);
        delete activeVoices[studentId][midi];
    }
}

/* =============================================================
   RECEIVE MIDI FROM SERVER
============================================================= */

socket.on("midi", (data) => {
    // data = { studentId, midi: [cmd, note, vel] }
    const { studentId, midi } = data;
    const [cmd, note, vel] = midi;

    const box = getStudentBox(studentId);

    // Flash yellow highlight
    box.classList.add("flash");
    setTimeout(() => box.classList.remove("flash"), 120);

    // Update last note label
    document.getElementById("note_" + studentId).innerText = midiToName(note);

    // Note on
    if (cmd === 144 && vel > 0) {
        playNote(studentId, note, vel);
    }

    // Note off
    if (cmd === 128 || (cmd === 144 && vel === 0)) {
        stopNote(studentId, note);
    }
});

</script>
</body>
</html>
