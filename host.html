<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Host â€“ MIDI Classroom</title>
</head>
<body>
  <h2>Host Page</h2>
  <label>Room Name:</label>
  <input id="room" placeholder="enter room" value="room1"><br><br>
  <button id="connectBtn">Start Hosting</button>
  <p id="status">Not connected</p>
  <pre id="log" style="background:#f6f6f6;padding:8px;"></pre>

  <script>
    // ====== CONFIG ======
    // Production websocket host given by you
    const PROD_WS = "wss://midi-classroom-production.up.railway.app";
    // Local testing
    const LOCAL_WS = "ws://localhost:8080";

    // Choose url automatically:
    // - if page is served from localhost or opened as file:// use local
    // - otherwise use production
    function selectWebSocketUrl() {
      if (location.hostname === "localhost" || location.protocol === "file:") {
        return LOCAL_WS;
      } else {
        return PROD_WS;
      }
    }

    // ====== UI helpers ======
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    function log(...args) { 
      console.log(...args);
      logEl.textContent += args.join(" ") + "\n";
    }
    function setStatus(s) {
      statusEl.innerText = s;
      log("STATUS:", s);
    }

    // ====== WebSocket & Audio ======
    let ws;
    let audioCtx;

    document.getElementById("connectBtn").addEventListener("click", () => {
      const room = document.getElementById("room").value || "room1";
      const wsUrl = selectWebSocketUrl();
      setStatus("Connecting to " + wsUrl + " ...");
      log("Using WS URL:", wsUrl);

      try {
        ws = new WebSocket(wsUrl);
      } catch (err) {
        setStatus("WebSocket constructor error");
        log(err);
        return;
      }

      ws.onopen = () => {
        setStatus("Connected to server");
        ws.send(JSON.stringify({ type: "join", role: "host", room }));
      };

      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === "midi") {
            playNote(msg.data);
          }
        } catch (e) {
          log("Invalid WS message", e);
        }
      };

      ws.onclose = (e) => {
        setStatus("Disconnected");
        log("WS closed", e);
      };

      ws.onerror = (e) => {
        setStatus("WebSocket error (check console & Railway logs)");
        log("WS error", e);
      };
    });

    // Simple audio synthesizer - short sine tone
    function playNote(data) {
      // data is [status, note, velocity]
      const [status, note, velocity] = data;
      const command = status & 0xf0;
      // handle note-on (0x90) and note-off (0x80). note-on with velocity 0 is also note-off.
      if ((command === 0x90 && velocity > 0)) {
        // create audio context lazily on first user interaction
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        // MIDI note to frequency
        const freq = 440 * Math.pow(2, (note - 69) / 12);
        osc.type = "sine";
        osc.frequency.value = freq;
        gain.gain.value = Math.max(0.02, velocity / 127); // keep audible
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        // stop after fixed duration (you can adapt or track note-off)
        osc.stop
