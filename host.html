<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Host – MIDI Classroom</title>

<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .studentBox {
        border: 2px solid #333;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #f3f3f3;
        transition: background 0.15s;
    }
    .flash {
        background: #ffe6a3 !important;
    }

    #monitorSelect {
        padding: 6px;
        margin-bottom: 20px;
    }

    #recordBtn {
        padding: 8px 14px;
        font-size: 15px;
        cursor: pointer;
    }
</style>
</head>
<body>

<h2>Host – MIDI Classroom</h2>

<!-- Volume Control -->
<div>
    <label>Volume: <span id="volLabel">80</span>%</label><br>
    <input id="volume" type="range" min="0" max="100" value="80" />
</div>

<br>

<!-- Student Monitor Selector -->
<label><b>Monitor Student:</b></label><br>
<select id="monitorSelect">
    <option value="ALL">ALL (default)</option>
</select>

<br><br>

<!-- Recording Controls -->
<button id="recordBtn">Start Recording</button>
<a id="downloadLink" style="display:none; margin-left:10px;" download="recording.mp3">Download MP3</a>

<hr>

<p id="status">Connecting…</p>

<h3>Student Activity</h3>
<div id="studentArea"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<script>
/* =============================================================
   CONNECT
============================================================= */
const socket = io();

socket.on("connect", () => {
    document.getElementById("status").innerText = "Connected to server";
});

/* =============================================================
   STUDENT UI BOXES
============================================================= */
const studentArea = document.getElementById("studentArea");
const students = new Map();
const monitorSelect = document.getElementById("monitorSelect");

function getStudentBox(studentId) {
    if (students.has(studentId)) return students.get(studentId);

    const box = document.createElement("div");
    box.className = "studentBox";
    box.id = "student_" + studentId;

    box.innerHTML = `
        <h3>Student ${studentId}</h3>
        <div>Last note: <span id="note_${studentId}">(none)</span></div>
    `;

    studentArea.appendChild(box);
    students.set(studentId, box);

    // Also add to monitor dropdown
    const option = document.createElement("option");
    option.value = studentId;
    option.innerText = "Student " + studentId;
    monitorSelect.appendChild(option);

    return box;
}

/* =============================================================
   HOST AUDIO ENGINE
============================================================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// Main output
let volumeGain = audioCtx.createGain();
volumeGain.gain.value = 0.8;

// Recording tap
let recordGain = audioCtx.createGain();
recordGain.gain.value = 1;

// Routing:
// synth voices -> recordGain -> volumeGain -> speakers
recordGain.connect(volumeGain).connect(audioCtx.destination);

volSlider = document.getElementById("volume");
volLabel = document.getElementById("volLabel");

volSlider.oninput = () => {
    volumeGain.gain.value = volSlider.value / 100;
    volLabel.innerText = volSlider.value;
};

function midiToFreq(note) {
    return 440 * Math.pow(2, (note - 69) / 12);
}
function midiToName(n) {
    const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    return names[n % 12] + (Math.floor(n / 12) - 1);
}

// Voices per student
let activeVoices = {};  // activeVoices[studentId][note] = osc/gain

/* =============================================================
   PLAY/STOP NOTE
============================================================= */
function playNote(studentId, midi, vel) {
    if (!activeVoices[studentId]) activeVoices[studentId] = {};

    // Only play if monitoring this student OR monitoring ALL
    const monitor = monitorSelect.value;
    const shouldPlay =
        monitor === "ALL" || monitor === String(studentId);

    if (!shouldPlay) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.value = midiToFreq(midi);
    gain.gain.value = (vel / 127) * 0.5;

    osc.connect(gain).connect(recordGain);

    osc.start();
    activeVoices[studentId][midi] = { osc, gain };
}

function stopNote(studentId, midi) {
    if (
        activeVoices[studentId] &&
        activeVoices[studentId][midi]
    ) {
        let v = activeVoices[studentId][midi];
        v.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03);
        v.osc.stop(audioCtx.currentTime + 0.05);
        delete activeVoices[studentId][midi];
    }
}

/* =============================================================
   RECEIVE MIDI FROM SERVER
============================================================= */
socket.on("midi", (data) => {
    const { studentId, midi } = data;
    const [cmd, note, vel] = midi;

    const box = getStudentBox(studentId);

    // Flash box
    box.classList.add("flash");
    setTimeout(() => box.classList.remove("flash"), 120);

    // Update note label
    document.getElementById("note_" + studentId).innerText = midiToName(note);

    if (cmd === 144 && vel > 0) playNote(studentId, note, vel);
    if (cmd === 128 || (cmd === 144 && vel === 0)) stopNote(studentId, note);
});

/* =============================================================
   MP3 RECORDING USING LAMEJS
============================================================= */
let recording = false;
let mp3Encoder;
let recordedChunks = [];

const recordBtn = document.getElementById("recordBtn");
const downloadLink = document.getElementById("downloadLink");

// Capture audio stream
const dest = audioCtx.createMediaStreamDestination();
recordGain.connect(dest);

let mediaRecorder = new MediaRecorder(dest.stream);

mediaRecorder.ondataavailable = (e) => {
    recordedChunks.push(e.data);
};

mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "audio/mp3" });
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.style.display = "inline-block";
    recordedChunks = [];
};

recordBtn.onclick = () => {
    if (!recording) {
        recording = true;
        downloadLink.style.display = "none";

        mediaRecorder.start();
        recordBtn.innerText = "Stop Recording";
    } else {
        recording = false;
        mediaRecorder.stop();
        recordBtn.innerText = "Start Recording";
    }
};
</script>
</body>
</html>
