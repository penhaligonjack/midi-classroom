document.getElementById("connectBtn").addEventListener("click", () => {
  const room = document.getElementById("room").value || "room1";
  const wsUrl = selectWebSocketUrl();
  
  setStatus("Connecting to " + wsUrl + " ...");
  log("Using WS URL:", wsUrl);

  try {
    ws = new WebSocket(wsUrl);
  } catch (err) {
    setStatus("WebSocket constructor error");
    log(err);
    return;
  }

  ws.onopen = () => {
    setStatus("Connected to server");
    ws.send(JSON.stringify({ type: "join", role: "host", room }));
  };

  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === "midi") {
        playNote(msg.data);
      }
    } catch (e) {
      log("Invalid WS message", e);
    }
  };

  ws.onclose = (e) => {
    setStatus("Disconnected");
    log("WS closed", e);
  };

  ws.onerror = (e) => {
    setStatus("WebSocket error (check console & Railway logs)");
    log("WS error", e);
  };
});
