<!DOCTYPE html>
<html>
<head>
    <title>Host - MIDI Classroom</title>
</head>
<body>
    <h1>Host – MIDI Classroom</h1>

    <button id="connect">Start Session</button>

    <script>
        let ws;
        let audioCtx;

        // -----------------------------------------------------
        //              ACOUSTIC PIANO SYNTHESIZER
        // -----------------------------------------------------

        function playNote(midiMessage) {
            const [command, note, velocity] = midiMessage;

            // We only care about Note On (144) and Note Off (128)
            if (command !== 144 && command !== 128) return;

            // Create audio context if this is the first note
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            const now = audioCtx.currentTime;

            // Convert MIDI note to frequency
            const freq = 440 * Math.pow(2, (note - 69) / 12);

            // Create oscillator + gain (envelope)
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.frequency.setValueAtTime(freq, now);
            osc.type = "sine"; // Base tone

            // Velocity sensitivity (0–1)
            const vol = velocity / 127;

            // Acoustic-piano style ADSR envelope
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + 0.01); // quick attack
            gain.gain.linearRampToValueAtTime(vol * 0.6, now + 0.15); // soften slightly
            gain.gain.exponentialRampToValueAtTime(0.0001, now + 2.0); // slow decay

            osc.connect(gain).connect(audioCtx.destination);

            osc.start(now);
            osc.stop(now + 2.2); // remove after decay
        }

        // -----------------------------------------------------
        //              WEBSOCKET CONNECTION
        // -----------------------------------------------------

        document.getElementById("connect").onclick = () => {

            // Connect automatically to your Railway WebSocket
            ws = new WebSocket(`wss://${window.location.host}`);

            ws.onopen = () => {
                console.log("Host connected.");
            };

            ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);

                    if (data.type === "midi") {
                        playNote(data.data);
                    }
                } catch (err) {
                    console.error("Invalid WS message", err);
                }
            };

            ws.onclose = () => {
                console.log("WebSocket closed");
            };

            ws.onerror = (e) => {
                console.error("WebSocket error", e);
            };
        };
    </script>
</body>
</html>
