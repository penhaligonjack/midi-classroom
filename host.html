<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Host – MIDI Classroom</title>
</head>
<body>
    <h2>Host – MIDI Classroom</h2>

    <label>Room Name:</label>
    <input id="room" value="room1"><br><br>

    <label>Volume:</label>
    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"><br><br>

    <button id="connectBtn">Start Session</button>

    <p id="status">Not connected</p>

    <h3>Incoming MIDI Log</h3>
    <pre id="log" style="background:#f6f6f6;padding:8px;height:200px;overflow-y:auto;"></pre>

    <!-- SoundFont Piano -->
    <script src="https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_grand_piano-mp3.js"></script>

    <script>
        // Auto websocket: Railway production OR localhost dev
        const PROD_WS = `wss://${window.location.host}`;
        const LOCAL_WS = "ws://localhost:8080";

        function selectWebSocketUrl() {
            return (location.hostname === "localhost") ? LOCAL_WS : PROD_WS;
        }

        // UI helpers
        const statusEl = document.getElementById("status");
        const logEl = document.getElementById("log");

        function log(...msg) {
            logEl.textContent += msg.join(" ") + "\n";
            logEl.scrollTop = logEl.scrollHeight;
        }
        function setStatus(s) { statusEl.textContent = s; }

        // WebAudio output
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        let piano = null;
        let masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.9;
        masterGain.connect(audioCtx.destination);

        // Load the SoundFont piano
        function loadPiano() {
            return new Promise(resolve => {
                piano = MIDI; // Loaded from CDN
                MIDI.setContext(audioCtx);
                resolve();
            });
        }

        document.getElementById("volume").oninput = (e) => {
            masterGain.gain.value = e.target.value;
        };

        let ws;

        document.getElementById("connectBtn").onclick = async () => {
            await audioCtx.resume();
            await loadPiano();

            const room = document.getElementById("room").value;
            const wsUrl = selectWebSocketUrl();

            setStatus("Connecting...");
            log("Connecting to:", wsUrl);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                setStatus("Connected");
                log("Host connected.");

                ws.send(JSON.stringify({
                    type: "join",
                    role: "host",
                    room
                }));
            };

            ws.onmessage = (ev) => {
                const msg = JSON.parse(ev.data);

                if (msg.type === "midi") {
                    let [cmd, note, vel] = msg.data;

                    log(`MIDI from student → cmd:${cmd} note:${note} vel:${vel}`);

                    // PLAY SOUNDFONT PIANO
                    if (cmd === 144 && vel > 0) piano.noteOn(0, note, vel / 127, 0);
                    if (cmd === 128 || (cmd === 144 && vel === 0)) piano.noteOff(0, note, 0);
                }
            };

            ws.onerror = (e) => log("WebSocket error:", e);
            ws.onclose = () => setStatus("Disconnected");
        };
    </script>
</body>
</html>
