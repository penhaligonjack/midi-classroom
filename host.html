<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Host – MIDI Classroom</title>
    <style>
        body { font-family: Arial; }
        .studentBox {
            border: 2px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            background: #eee;
            transition: background 0.15s;
        }
        .flash {
            background: #ffdd99 !important;
        }
    </style>
</head>
<body>
    <h2>Host – MIDI Classroom</h2>

    <!-- CLASSROOM SELECT -->
    <label>Choose Classroom:</label>
    <select id="room">
        <option value="77">Classroom 77</option>
        <option value="78">Classroom 78</option>
    </select>
    <br><br>

    <button id="connectBtn">Start Hosting</button>
    <p id="status">Not connected</p>

    <!-- VOLUME -->
    <label>Volume: <span id="volLabel">80</span>%</label><br>
    <input type="range" id="volume" min="0" max="100" value="80" />
    <br><br>

    <h3>Student Activity</h3>
    <div id="studentArea"></div>

    <script>
        // Auto WebSocket URL
        const PROD_WS = `wss://${window.location.host}`;
        const LOCAL_WS = "ws://localhost:8080";

        function selectWebSocketUrl() {
            return (location.hostname === "localhost") ? LOCAL_WS : PROD_WS;
        }

        // UI references
        const statusEl = document.getElementById("status");
        const studentArea = document.getElementById("studentArea");
        const volSlider = document.getElementById("volume");
        const volLabel = document.getElementById("volLabel");

        function setStatus(s) { statusEl.textContent = s; }

        // Piano engine
        let audioCtx = null;
        let volumeGain = null;
        let activeVoices = {};

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                volumeGain = audioCtx.createGain();
                volumeGain.gain.value = volSlider.value / 100;
                volumeGain.connect(audioCtx.destination);
            }
        }

        volSlider.oninput = () => {
            volLabel.textContent = volSlider.value;
            if (volumeGain) volumeGain.gain.value = volSlider.value / 100;
        };

        function midiToFreq(note) {
            return 440 * Math.pow(2, (note - 69) / 12);
        }

        function midiToName(n) {
            const names = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            return names[n % 12] + (Math.floor(n / 12) - 1);
        }

        function playNote(studentID, note, velocity) {
            initAudio();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = "sine";
            osc.frequency.value = midiToFreq(note);
            gain.gain.value = Math.max(0.05, velocity / 127);

            osc.connect(gain);
            gain.connect(volumeGain);
            osc.start();

            // Stop note after fixed time (simple polyphony)
            osc.stop(audioCtx.currentTime + 0.6);
        }

        // --- Manage Student UI Boxes ---
        const students = new Map();

        function getStudentBox(keyboardNum) {
            if (students.has(keyboardNum)) return students.get(keyboardNum);

            // Create box
            const box = document.createElement("div");
            box.className = "studentBox";
            box.id = "student_" + keyboardNum;
            box.innerHTML = `
                <h3>Keyboard ${keyboardNum}</h3>
                <div>Last note: <span id="note_${keyboardNum}">(none)</span></div>
            `;
            studentArea.appendChild(box);
            students.set(keyboardNum, box);
            return box;
        }

        // --- WebSocket Setup ---
        let ws;

        document.getElementById("connectBtn").onclick = () => {
            const room = document.getElementById("room").value;

            ws = new WebSocket(selectWebSocketUrl());

            ws.onopen = () => {
                setStatus("Connected");
                ws.send(JSON.stringify({ type: "join", role: "host", room }));
            };

            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);

                if (data.type === "student-join") {
                    const box = getStudentBox(data.keyboard);
                    return;
                }

                if (data.type === "midi") {
                    const { keyboard, midi } = data;
                    const [cmd, note, vel] = midi;

                    const box = getStudentBox(keyboard);

                    // Update UI note name
                    document.getElementById("note_" + keyboard).textContent = midiToName(note);

                    // Flash indicator
                    box.classList.add("flash");
                    setTimeout(() => box.classList.remove("flash"), 120);

                    // Play through speakers
                    if (cmd === 144 && vel > 0) {
                        playNote(keyboard, note, vel);
                    }
                }
            };

            ws.onclose = () => setStatus("Disconnected");
            ws.onerror = () => setStatus("WebSocket error");
        };
    </script>
</body>
</html>
